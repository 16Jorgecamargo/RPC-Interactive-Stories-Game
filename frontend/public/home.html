<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taverna do Aventureiro</title>
  <script src="/config.js"></script>
  <link rel="stylesheet" href="/src/styles/home.css">
  <link rel="stylesheet" href="/src/styles/tab-blocked-modal.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>🏰 Taverna do Aventureiro</h1>
      <p>
        Bem-vindo de volta, <strong><span class="username" id="username">Aventureiro</span></strong>! ⚔️
      </p>
      <button class="logout-btn" id="logoutBtn">🚪 Sair</button>
    </div>

    <div class="sessions-container">
      <h2 class="sessions-title">🎮 Suas Aventuras</h2>

      <div id="loadingMessage" class="loading">
        Carregando aventuras...
      </div>

      <div id="errorMessage" class="error-message" style="display: none;">
        Erro ao carregar sessões. Por favor, tente novamente.
      </div>

      <div id="noSessions" class="no-sessions" style="display: none;">
        <div class="no-sessions-icon">🎭</div>
        <h3>Nenhuma Aventura em Andamento</h3>
        <p>Parece que você ainda não está participando de nenhuma história épica.<br>Que tal começar uma nova aventura?</p>
      </div>

      <div id="sessionsList" class="sessions-grid"></div>
      
      <div id="pagination" class="pagination" style="display: none;"></div>
    </div>

    <div class="actions-container">
      <button class="btn btn-primary" id="createSessionBtn">⚔️ Criar Nova Sessão</button>
      <button class="btn btn-success" id="joinSessionBtn">🗝️ Entrar via Código</button>
    </div>
  </div>

  <script type="module">
    import { requireAuth, logout } from '/src/utils/auth.js';
    import { loadHome, renderHomeData } from '/src/ui/home.js';
    import tabManager from '/src/utils/tabManager.js';
    import { showTabBlockedModal, hideTabBlockedModal } from '/src/ui/shared/tabBlockedModal.js';

    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');

    async function init() {
      tabManager.init(
        () => {
          console.log('[HOME] Aba bloqueada - outra aba assumiu controle');
          showTabBlockedModal();
        },
        () => {
          console.log('[HOME] Aba desbloqueada - reassumindo controle');
          hideTabBlockedModal();
        }
      );

      if (!tabManager.isLeaderTab()) {
        console.log('[HOME] Aba não é líder, aguardando...');
        return;
      }

      const user = await requireAuth();

      if (!user) {
        return;
      }

      try {
        const homeData = await loadHome();
        loadingMessage.style.display = 'none';
        renderHomeData(homeData);
      } catch (error) {
        console.error('Erro ao carregar home:', error);
        loadingMessage.style.display = 'none';
        errorMessage.style.display = 'block';
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      logout();
      window.location.href = '/login.html';
    });

    document.getElementById('createSessionBtn').addEventListener('click', () => {
      window.location.href = '/session-create.html';
    });

    document.getElementById('joinSessionBtn').addEventListener('click', () => {
      console.log('Botão Entrar via Código - Use o dialog');
    });

    init();
  </script>
</body>
</html>
